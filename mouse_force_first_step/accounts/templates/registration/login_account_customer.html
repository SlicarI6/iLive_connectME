{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sign in</title>
    <link rel="stylesheet" href="{% static 'css/login_customer_account_style.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="card login-card">

        <!-- STEP 1: LOGIN BY EMAIL -->
        <div id="step1" class="card-body">
            <h3 class="card-title mb-4">Sign in</h3>
            <form id="emailForm">
                {% csrf_token %}
                <div class="mb-3">
                    <input type="email" name="email" id="emailInput" class="form-control" placeholder="Email, phone, or Skype" required>
                </div>
                <div class="mb-2">
                    <span class="signup-text">No account? <a href="{% url 'customer_account_signup' %}">Create one!</a></span>
                </div>
                <div class="text-end mt-4">
                    <button type="submit" class="btn btn-primary next-btn">Next</button>
                </div>
            </form>
            <div id="emailError" class="text-danger mt-2" style="display:none;">This email does not exist.</div>
        </div>

        <!-- STEP 2: PASSWORD FOR EMAIL -->
        <div id="step2" class="card-body" style="display:none;">
            <button id="backToEmail" class="btn btn-link">&larr;</button>
            <h3 class="card-title mb-4" id="emailDisplay">Email</h3>
            <form method="post" action="{% url 'login_account_customer' %}">
                {% csrf_token %}
                <input type="hidden" name="username" id="hiddenEmail">
                <div class="mb-3">
                    <input type="password" name="password" class="form-control" placeholder="Password" required>
                </div>
                <div class="text-end">
                    <button type="submit" class="btn btn-primary">Sign in</button>
                </div>
            </form>
        </div>

        <!-- STEP 1: LOGIN BY USERNAME -->
        <div id="step1_username" class="card-body" style="display:none;">
            <h3 class="card-title mb-4">Sign in with Username</h3>
            <form id="usernameForm">
                {% csrf_token %}
                <div class="mb-3">
                    <input type="text" name="username" id="usernameInput" class="form-control" placeholder="Username" required>
                </div>
                <div class="text-end mt-2">
                    <button type="submit" class="btn btn-primary next-btn">Next</button>
                </div>
            </form>
            <div id="usernameError" class="text-danger mt-2" style="display:none;">This username does not exist.</div>
            <div class="mt-2">
                <a href="#" onclick="showRecoverUsername()">Forgot username?</a>
            </div>
        </div>

        <!-- STEP 2: PASSWORD FOR USERNAME -->
        <div id="step2_username" class="card-body" style="display:none;">
            <button id="backToUsername" class="btn btn-link">&larr;</button>
            <h3 class="card-title mb-4" id="usernameDisplay">Username</h3>
            <form method="post" action="{% url 'login_account_customer' %}">
                {% csrf_token %}
                <input type="hidden" name="username" id="hiddenUsername">
                <div class="mb-3">
                    <input type="password" name="password" class="form-control" placeholder="Password" required>
                </div>
                <div class="text-end">
                    <button type="submit" class="btn btn-primary">Sign in</button>
                </div>
            </form>
        </div>

        <!-- STEP 1: RECOVER USERNAME -->
        <div id="recoverUsernameForm" class="card-body" style="display:none;">
            <h4 class="card-title mb-3">Recover your username</h4>
            <form id="recoverForm">
                {% csrf_token %}
                <input type="email" id="recoverEmail" class="form-control mb-3" placeholder="Enter your email" required>
                <button type="submit" class="btn btn-primary">Recover</button>
            </form>
            <div id="recoverResult" class="mt-3 text-success" style="display:none;"></div>
            <div id="recoverError" class="mt-3 text-danger" style="display:none;">This email was not found.</div>
        </div>

        <!-- AUTHENTICATION OPTIONS -->
        <div id="authOptions" class="card-body" style="display:none;">
            <h5 class="mb-3">Choose login method:</h5>
            <button onclick="showUsernameLogin()" class="btn btn-outline-dark mb-2 w-100">üî§ Login with Username</button>
            <button class="btn btn-outline-secondary w-100" disabled>üîê Login with Google (soon)</button>
        </div>
    </div>

    <!-- AUTH OPTIONS BUTTONS -->
    <div class="login-option-wrapper">
        <div id="authOptionsButton" class="login-option-bar" onclick="showAuthOptions()">
            <i class="fa-solid fa-key login-option-icon"></i>
            <span class="login-option-text">Authentication Options</span>
        </div>
        <div id="authBackButton" class="login-option-bar" onclick="returnToSignIn()" style="display:none;">
            <i class="fa-solid fa-arrow-left login-option-icon"></i>
            <span class="login-option-text">Back to Sign in</span>
        </div>
    </div>

    <script>
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step1_username = document.getElementById('step1_username');
        const step2_username = document.getElementById('step2_username');
        const authOptions = document.getElementById('authOptions');

        const emailForm = document.getElementById('emailForm');
        const usernameForm = document.getElementById('usernameForm');
        const backButton = document.getElementById('backToEmail');
        const backToUsername = document.getElementById('backToUsername');

        // Email login
        emailForm.addEventListener('submit', function (e) {
            e.preventDefault();
            const email = document.getElementById('emailInput').value;
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            fetch("{% url 'check_email_exists_customer_account' %}", {
                method: "POST",
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ email: email })
            })
            .then(res => res.json())
            .then(data => {
                if (data.exists) {
                    step1.style.display = 'none';
                    step2.style.display = 'block';
                    document.getElementById('emailDisplay').textContent = email;
                    document.getElementById('hiddenEmail').value = email;
                } else {
                    document.getElementById('emailError').style.display = 'block';
                }
            });
        });

        backButton.addEventListener('click', () => {
            step2.style.display = 'none';
            step1.style.display = 'block';
        });

        // Username login
        usernameForm.addEventListener('submit', function (e) {
            e.preventDefault();
            const username = document.getElementById('usernameInput').value;
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            fetch("{% url 'check_username_exists_customer_account' %}", {
                method: "POST",
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ username: username })
            })
            .then(res => res.json())
            .then(data => {
                if (data.exists) {
                    step1_username.style.display = 'none';
                    step2_username.style.display = 'block';
                    document.getElementById('usernameDisplay').textContent = username;
                    document.getElementById('hiddenUsername').value = username;
                } else {
                    document.getElementById('usernameError').style.display = 'block';
                }
            });
        });

        backToUsername.addEventListener('click', () => {
            step2_username.style.display = 'none';
            step1_username.style.display = 'block';
        });

        // Recover username
        function showRecoverUsername() {
            step1_username.style.display = 'none';
            document.getElementById('recoverUsernameForm').style.display = 'block';
        }

        document.getElementById('recoverForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const email = document.getElementById('recoverEmail').value;
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            fetch("{% url 'recover_username_customer' %}", {
                method: "POST",
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ email: email })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('recoverResult').innerHTML = `
                        Your username is: <strong>${data.username}</strong><br>
                        <button onclick="continueWithRecoveredUsername('${data.username}')" class="btn btn-link mt-2">‚û°Ô∏è Continue to login</button>
                    `;
                    document.getElementById('recoverResult').style.display = 'block';
                    document.getElementById('recoverError').style.display = 'none';
                } else {
                    document.getElementById('recoverError').style.display = 'block';
                    document.getElementById('recoverResult').style.display = 'none';
                }
            });
        });

        function continueWithRecoveredUsername(username) {
            document.getElementById('recoverUsernameForm').style.display = 'none';
            step2_username.style.display = 'block';
            document.getElementById('usernameDisplay').textContent = username;
            document.getElementById('hiddenUsername').value = username;
        }

        // Auth options
        function showAuthOptions() {
            step1.style.display = 'none';
            step2.style.display = 'none';
            step1_username.style.display = 'none';
            step2_username.style.display = 'none';
            document.getElementById('recoverUsernameForm').style.display = 'none';
            authOptions.style.display = 'block';
            document.getElementById('authOptionsButton').style.display = 'none';
            document.getElementById('authBackButton').style.display = 'flex';
        }

        function returnToSignIn() {
            authOptions.style.display = 'none';
            step1.style.display = 'block';
            step2.style.display = 'none';
            step1_username.style.display = 'none';
            step2_username.style.display = 'none';
            document.getElementById('recoverUsernameForm').style.display = 'none';
            document.getElementById('authOptionsButton').style.display = 'flex';
            document.getElementById('authBackButton').style.display = 'none';
        }

        function showEmailLogin() {
            authOptions.style.display = 'none';
            step1.style.display = 'block';
        }

        function showUsernameLogin() {
            authOptions.style.display = 'none';
            step1_username.style.display = 'block';
        }
    </script>
</body>
</html>
